(function(o,d){typeof exports=="object"&&typeof module!="undefined"?d(exports,require("@swc/wasm-web"),require("path-browserify"),require("magic-string"),require("json5")):typeof define=="function"&&define.amd?define(["exports","@swc/wasm-web","path-browserify","magic-string","json5"],d):(o=typeof globalThis!="undefined"?globalThis:o||self,d(o.BridgeJsRuntime={},o.init,o.pathBrowserify,o.MagicString,o.json5))})(this,function(o,d,p,w,y){"use strict";function _(u){return u&&typeof u=="object"&&"default"in u?u:{default:u}}var v=_(d),m=_(w),M=_(y);function $(u,e,r=0){const i=new m.default(u),n=(t,s,a)=>i.overwrite(t-r,s-r,a),f=(t,s)=>i.slice(t-r,s-r);let c="";return e.forEach(t=>{if(t.type==="ExportDefaultDeclaration")n(t.span.start,t.span.end,`
___module.__default__ = ${f(t.decl.span.start,t.decl.span.end)};`);else if(t.type==="ExportDefaultExpression")n(t.span.start,t.span.end,`
___module.__default__ = ${f(t.expression.span.start,t.expression.span.end)};`);else if(t.type==="ExportDeclaration")n(t.span.start,t.span.end,f(t.declaration.span.start,t.declaration.span.end)),t.declaration.type==="ClassDeclaration"||t.declaration.type==="FunctionDeclaration"?c+=`
___module.${t.declaration.identifier.value} = ${t.declaration.identifier.value};`:t.declaration.type==="VariableDeclaration"&&t.declaration.declarations.forEach(s=>{c+=`
___module.${s.id.value} = ${s.id.value};`});else if(t.type==="ExportNamedDeclaration"){let s="";for(const{orig:a,exported:l}of t.specifiers)l.value==="default"?s+=`
___module.__default__ = ${a.value};`:s+=`
___module.${l.value} = ${a.value};`;n(t.span.start,t.span.end,s)}else if(t.type==="ImportDeclaration")if(t.specifiers.length===1&&t.specifiers[0].type==="ImportNamespaceSpecifier")n(t.span.start,t.span.end,`
const ${t.specifiers[0].local.value} = await ___require(${t.source.raw});`);else{const s=[];t.specifiers.forEach(l=>{l.type==="ImportDefaultSpecifier"?s.push(`__default__: ${l.local.value}`):l.type==="ImportSpecifier"&&(l.imported||(l.imported=l.local),s.push(`${l.imported.value}: ${l.local.value}`))});const a=s.length===0?`
await ___require(${t.source.raw});`:`
const {${s.join(", ")}} = await ___require(${t.source.raw});`;n(t.span.start,t.span.end,a)}}),i.toString()+c}class h{constructor(e,r){this.__default__=e;for(const[i,n]of Object.entries(r))this[i]=n}}const g=typeof process!="undefined"&&typeof process.release!="undefined"&&process.release.name==="node";class b{constructor(e){if(this.evaluatedModules=new Map,this.baseModules=new Map,this.moduleLoaders=new Map,this.env={},e)for(const[r,i]of e)this.registerModule(r,i)}async run(e,r={},i){return await this.eval(e,r,i)}clearCache(){this.evaluatedModules.clear()}registerModule(e,r){this.baseModules.set(e,r)}deleteModule(e){this.baseModules.delete(e)}addModuleLoader(e,r){this.baseModules.set(e,r)}async eval(e,r,i){const n=this.evaluatedModules.get(e);if(n)return n;const f=p.dirname(e);if(i||(i=await this.readFile(e).catch(()=>{})),!i)throw new Error(`File "${e}" not found`);const c=await i.text(),t=await this.transformSource(e,c),s={};try{await this.runSrc(t,Object.assign({},r,{___module:s,___require:a=>this.require(a,f,r)}))}catch(a){throw new Error(`Error in ${e}: ${a}`)}return this.evaluatedModules.set(e,s),s}async transformSource(e,r){const i=e.endsWith(".js")?"ecmascript":"typescript";if(o.loadedWasm===null&&!g)throw new Error("You must call initRuntimes() before using the runtime");await o.loadedWasm;let n=d.minifySync(d.transformSync(r,{filename:p.basename(e),jsc:{parser:{syntax:i,preserveAllComments:!1,topLevelAwait:!0},target:"es2020"}}).code,{compress:!1,mangle:!1,format:{beautify:!0}}).code;const{type:f,body:c}=d.parseSync(n,{syntax:i,target:"es2022"}),t=c[0].span.start;return $(n,c,t)}async require(e,r,i){const n=this.baseModules.get(e);if(n)if(typeof n=="string"){const s=new File([n],e);return await this.eval(e,i,s)}else return typeof n=="function"?await n():n;if(e.startsWith("https://")){const s=await fetch(e),a=new File([await s.blob()],e);return await this.eval(e,i,a)}e.startsWith(".")&&(e=p.join(r,e));const f=p.extname(e);if(f===".json"){const s=await this.readFile(e).then(a=>a.text()).catch(()=>{});if(s){let a={};try{a=M.default.parse(s)}catch{throw new Error(`File "${e}" contains invalid JSON`)}return new h(a,a)}}const c=this.moduleLoaders.get(f);if(c){const s=this.evaluatedModules.get(e);if(s)return s;const a=c(e);return a instanceof h?(this.evaluatedModules.set(e,a),a):await this.eval(e,i,a)}const t=[".ts",".js"];for(const s of t){const a=`${e}${s}`;let l=await this.readFile(a).catch(()=>{});if(!!l)return await this.eval(a,i,l)}throw new Error(`Module "${e}" not found`)}async runSrc(e,r){return new Function(...Object.keys(r),`return (async () => {
${e}
})()`)(...Object.values(r))}}o.loadedWasm=null;function j(u){o.loadedWasm=v.default(u).then(()=>null)}o.Module=h,o.Runtime=b,o.initRuntimes=j,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
