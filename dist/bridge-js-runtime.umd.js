(function(s,p){typeof exports=="object"&&typeof module!="undefined"?p(exports,require("@swc/wasm-web"),require("path-browserify"),require("magic-string"),require("json5")):typeof define=="function"&&define.amd?define(["exports","@swc/wasm-web","path-browserify","magic-string","json5"],p):(s=typeof globalThis!="undefined"?globalThis:s||self,p(s.BridgeJsRuntime={},s.init,s.pathBrowserify,s.MagicString,s.json5))})(this,function(s,p,d,v,m){"use strict";function _(c){return c&&typeof c=="object"&&"default"in c?c:{default:c}}var y=_(p),$=_(v),g=_(m);function j(c,e,a=0){const n=new $.default(c),o=(t,r,f)=>n.overwrite(t-a,r-a,f),u=(t,r)=>n.slice(t-a,r-a);let i="";return e.forEach(t=>{if(t.type==="ExportDefaultDeclaration")o(t.span.start,t.span.end,`
___module.__default__ = ${u(t.decl.span.start,t.decl.span.end)};`);else if(t.type==="ExportDefaultExpression")o(t.span.start,t.span.end,`
___module.__default__ = ${u(t.expression.span.start,t.expression.span.end)};`);else if(t.type==="ExportDeclaration")o(t.span.start,t.span.end,u(t.declaration.span.start,t.declaration.span.end)),t.declaration.type==="ClassDeclaration"||t.declaration.type==="FunctionDeclaration"?i+=`
___module.${t.declaration.identifier.value} = ${t.declaration.identifier.value};`:t.declaration.type==="VariableDeclaration"&&t.declaration.declarations.forEach(r=>{i+=`
___module.${r.id.value} = ${r.id.value};`});else if(t.type==="ExportNamedDeclaration"){let r="";for(const{orig:f,exported:l}of t.specifiers)l.value==="default"?r+=`
___module.__default__ = ${f.value};`:r+=`
___module.${l.value} = ${f.value};`;o(t.span.start,t.span.end,r)}else if(t.type==="ImportDeclaration")if(t.specifiers.length===1&&t.specifiers[0].type==="ImportNamespaceSpecifier")o(t.span.start,t.span.end,`
const ${t.specifiers[0].local.value} = await ___require(${t.source.raw});`);else{const r=[];t.specifiers.forEach(l=>{l.type==="ImportDefaultSpecifier"?r.push(`__default__: ${l.local.value}`):l.type==="ImportSpecifier"&&(l.imported||(l.imported=l.local),r.push(`${l.imported.value}: ${l.local.value}`))});const f=r.length===0?`
await ___require(${t.source.raw});`:`
const {${r.join(", ")}} = await ___require(${t.source.raw});`;o(t.span.start,t.span.end,f)}}),n.toString()+i}class M{constructor(e){if(this.evaluatedModules=new Map,this.baseModules=new Map,this.env={},e)for(const[a,n]of e)this.registerModule(a,n)}async run(e,a={},n){return this.env=a,await this.eval(e,n)}clearCache(){this.evaluatedModules.clear()}registerModule(e,a){this.baseModules.set(e,a)}async eval(e,a){const n=this.evaluatedModules.get(e);if(n)return n;const o=d.dirname(e),u=e.endsWith(".js")?"ecmascript":"typescript";if(a||(a=await this.readFile(e).catch(()=>{})),!a)throw new Error(`File "${e}" not found`);if(s.loadedWasm===null)throw new Error("You must call initRuntimes() before using the runtime");await s.loadedWasm;let i=p.minifySync(p.transformSync(a,{filename:d.basename(e),jsc:{parser:{syntax:u,preserveAllComments:!1,topLevelAwait:!0},target:"es2020"}}).code,{compress:!1,mangle:!1,format:{beautify:!0}}).code;const{type:t,body:r}=p.parseSync(i,{syntax:u,target:"es2022"}),f=r[0].span.start,l=j(i,r,f),h={};try{await this.runSrc(l,Object.assign({},this.env,{___module:h,___require:w=>this.require(w,o)}))}catch(w){throw new Error(`Error in ${e}: ${w}`)}return this.evaluatedModules.set(e,h),h}async require(e,a){const n=this.baseModules.get(e);if(n)return n;if(e.startsWith("https://")){const i=await(await fetch(e)).text();return this.eval(e,i)}if(e.startsWith(".")&&(e=d.join(a,e)),e.endsWith(".json")){const u=await this.readFile(e).catch(()=>{});if(u){let i={};try{i=g.default.parse(u)}catch{throw new Error(`File "${e}" contains invalid JSON`)}return{__default__:i,...i}}}const o=[".ts",".js"];for(const u of o){const i=`${e}${u}`;let t=await this.readFile(i).catch(()=>{});if(!!t)return await this.eval(i,t)}throw new Error(`Module "${e}" not found`)}async runSrc(e,a){return new Function(...Object.keys(a),`return (async () => {
${e}
})()`)(...Object.values(a))}}s.loadedWasm=null;function b(c){s.loadedWasm=y.default(c).then(()=>null)}s.Runtime=M,s.initRuntimes=b,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
